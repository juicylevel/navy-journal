function windowLoadEventHandler(n){initApplication()}function initApplication(){Notifier.getInstance().init(),Dialog.getInstance().init();var n=ModuleManager.getInstance().getModule(JOURNAL);n.view.render()}window.addEventListener("load",windowLoadEventHandler);
function Controller(e,t,r){Receiver.apply(this,arguments),this.model=e,this.view=t,this.service=r}extend(Controller,Receiver),Controller.prototype.getHandlers=function(){return[{type:VIEW_READY,handler:this.init}]},Controller.prototype.init=function(){};
function Dispatcher(){this.receiversMap={}}Dispatcher.prototype.addReceiver=function(e){if(e instanceof Receiver){var r=e.getHandlers();if(!isEmpty(r))for(var i in r){var t=r[i];this.addReceiverToMap(t,e)}}},Dispatcher.prototype.addReceiverToMap=function(e,r){var i=e.type,t=e.handler;i in this.receiversMap||(this.receiversMap[i]=[]);var a=getElementByFieldValue("receiver",r,this.receiversMap[i]);isEmpty(a)&&this.receiversMap[i].push({receiver:r,handler:t})},Dispatcher.prototype.removeObserver=function(e){},Dispatcher.prototype.removeAllReceivers=function(){this.receiversMap={}},Dispatcher.prototype.sendNotification=function(e){var r=this.receiversMap[e.type];if(!isEmpty(r))for(var i in r){var t=r[i];t.handler.call(t.receiver,e.data)}};
function Model(){Dispatcher.apply(this,arguments)}extend(Model,Dispatcher);
function Notification(t,i){this.type=t,this.data=i}
function Receiver(){Dispatcher.apply(this,arguments)}extend(Receiver,Dispatcher),Receiver.prototype.getHandlers=function(){return null};
function View(e){Receiver.apply(this,arguments),this.domElement=e}extend(View,Receiver),View.prototype.render=function(){};
var Dialog=function(t,e){function n(){return this instanceof n?void 0:new n}var i;return n.prototype={init:function(){this.rootDomElement=e.getElementById("popup")},show:function(t,e,n){n=isEmpty(n)?"Сообщение":n;var i=this.createDialogBody(t,e,n);this.rootDomElement.getElementsByClassName("tint").length<1&&this.addTint(),this.rootDomElement.appendChild(i),this.toCenter(i)},addTint:function(){this.rootDomElement.style.right="0px",this.rootDomElement.style.bottom="0px";var t=e.createElement("div");t.className="tint",this.rootDomElement.appendChild(t);var n=e.getElementById("content");n.classList.add("blur")},removeTint:function(){var t=this.rootDomElement.getElementsByClassName("tint")[0];if(!isEmpty(t)){this.rootDomElement.removeChild(t),this.rootDomElement.style.right="",this.rootDomElement.style.bottom="";var n=e.getElementById("content");n.classList.remove("blur")}},toCenter:function(e){var n=getBounds(e),i=(t.innerWidth-n.width)/2,o=(t.innerHeight-n.height)/2;e.style.left=100*i/t.innerWidth+"%",e.style.top=100*o/t.innerHeight+"%"},createDialogBody:function(t,n,i){var o=e.createElement("div");o.className="dialogBody";var s='<div class="title">'+i+'</div><div class="message">'+t+'</div><div buttons class="buttons"></div>';o.innerHTML=s;var r,l=this,a=getEl(o,"buttons");for(var m in n)"context"!=m&&(r=e.createElement("button"),r.innerHTML=m,r.buttonName=m,r.addEventListener("click",function(){var t=n[this.buttonName];isEmpty(t)||t.call(n.context),l.removeDialog(o)}),a.appendChild(r));return o},removeDialog:function(t){this.rootDomElement.removeChild(t),this.rootDomElement.getElementsByClassName("dialogBody").length<1&&this.removeTint()}},{init:function(){return i?i:i=n.apply(null,arguments)},getInstance:function(){return i?i:this.init.apply(this,arguments)}}}(window,document);
function JournalLayout(){window.addEventListener("resize",function(t){this.calculate()}.bind(this),!0),this.calculate()}JournalLayout.prototype.calculate=function(){var t=document.getElementById("layoutBody"),e=document.getElementById("header"),n=document.getElementById("navigationPanel"),o=document.getElementById("navigation"),a=this.getElementVGap(t),i=this.getElementVGap(e),l=this.getElementVGap(n),r=this.getElementVGap(o),u=this.getElementHeight(e),d=this.getElementHeight(o),g=d+u+r+l+a+i,p=a+l+i+u,m=window.innerHeight;g>=m?n.style.height=d+r+"px":n.style.height=m-p+"px"},JournalLayout.prototype.getElementHeight=function(t){var e=document.defaultView.getComputedStyle(t,null),n=parseInt(e.height);return n},JournalLayout.prototype.getElementVGap=function(t){var e=document.defaultView.getComputedStyle(t,null);return parseInt(e.marginTop)+parseInt(e.marginBottom)+parseInt(e.borderTopWidth)+parseInt(e.borderBottomWidth)+parseInt(e.paddingTop)+parseInt(e.paddingBottom)};
var Notifier=function(e){function t(){return this instanceof t?void 0:new t}var i;return t.prototype={init:function(){this.rootDomElement=e.getElementById("notifications")},showProgress:function(t){var i=e.createElement("div");i.setAttribute("progress",null),i.className="progress";var n='<div message-container class="messageContainer"><div message-text>'+t+'</div><div progress-time class="progressTime"></div></div><div class="preloader"></div><div class="clearBoth"></div>';i.innerHTML=n;var s=function(){var e=getEl(i,"progress-time");e.innerHTML="выполняется: "+i.progressTime++ +" сек"};return i.progressTime=0,s(),i.progressTimer=setInterval(s,1e3),this.rootDomElement.appendChild(i),i},hideProgress:function(e){clearInterval(e.progressTimer),this.rootDomElement.removeChild(e)},showSuccess:function(e){var t=this.createNotificationItem("success",e);t.showTimer=setTimeout(function(){this.removeNotificationItem(t)}.bind(this),1e3*Settings.getInstance().config.ui.showNotificationTime),this.rootDomElement.appendChild(t)},showError:function(e,t){var i=this.createNotificationItem("error",e,t);this.rootDomElement.appendChild(i)},createNotificationItem:function(t,i,n){var s=e.createElement("div");s.className=t;var r='<div message-container class="messageContainer"><div message-text>'+i+'</div></div><div close-button class="closeButton"></div><div class="clearBoth"></div>';if(s.innerHTML=r,!isEmpty(n)){var o=this.createDetails(n),a=getEl(s,"message-text");a.parentNode.insertBefore(o,a.nextSibling)}var c=getEl(s,"close-button");return c.addEventListener("click",function(){this.removeNotificationItem(s)}.bind(this)),s},createDetails:function(t){var i=e.createElement("div"),n='<div details-button class="showDetailsButton">подробнее</div><div details-text style="display: none;">'+t+"</div>";i.innerHTML=n;var s=getEl(i,"details-button");return s.addEventListener("click",function(){var e=getEl(i,"details-text");"none"==e.style.display?(e.style.display="block",s.innerHTML="скрыть"):(e.style.display="none",s.innerHTML="подробнее")}),i},removeNotificationItem:function(e){clearTimeout(e.showTimer),this.rootDomElement.removeChild(e)}},{init:function(){return i?i:i=t.apply(null,arguments)},getInstance:function(){return i?i:this.init.apply(this,arguments)}}}(document);
function Paginator(t){Widget.apply(this,arguments),this.data=null,this.total=null,this.maxPageSize=t||10,this.pageSize=0,this.offset=0,this.currentPage=1}extend(Paginator,Widget),Paginator.prototype.render=function(){var t='<div><span>Показывать по:&nbsp;</span><input type="text" pageSizeInput></div><div><button type="button" refreshGridButton>Обновить</button></div><div><button type="button" firstPageButton>В начало</button><button type="button" backPageButton>Назад</button><button type="button" nextPageButton>Вперёд</button><button type="button" lastPageButton>В конец</button></div><div><input type="text" currentPageInput><button type="button" goToPageButton>Перейти</button></div><div>Записи с <span fromRecord></span> по <span toRecord></span></div><div>Всего: <span total></span></div>';this.domElement=document.createElement("div"),this.domElement.className="paginator",this.domElement.innerHTML=t,this.addEventListeners({firstPageButton:"click",backPageButton:"click",nextPageButton:"click",lastPageButton:"click",refreshGridButton:"click",goToPageButton:"click",pageSizeInput:"keypress",currentPageInput:"keypress"})},Paginator.prototype.refresh=function(){this.offset=0,this.dispatchChangePageEvent()},Paginator.prototype.addEventListeners=function(t){for(var e in t){var a=getEl(this.domElement,e),i=t[e],n="on"+capitalize(i)+capitalize(e);a.addEventListener(i,this[n].bind(this))}},Paginator.prototype.setData=function(t,e){this.data=t,this.total=e,this.updateDisplayValues()},Paginator.prototype.onClickFirstPageButton=function(){this.offset=0,this.updateDisplayValues(),this.dispatchChangePageEvent()},Paginator.prototype.onClickBackPageButton=function(){var t=this.getPageSize(),e=this.offset-t;e>=0&&(this.offset=e,this.updateDisplayValues(),this.dispatchChangePageEvent())},Paginator.prototype.onClickNextPageButton=function(){var t=this.getPageSize(),e=this.offset+t;e<=this.total-1&&(this.offset=e,this.updateDisplayValues(),this.dispatchChangePageEvent())},Paginator.prototype.onClickLastPageButton=function(){var t=Math.ceil(this.total/this.getPageSize());this.offset=(t-1)*this.getPageSize(),this.updateDisplayValues(),this.dispatchChangePageEvent()},Paginator.prototype.onClickRefreshGridButton=function(){this.refresh()},Paginator.prototype.onClickGoToPageButton=function(){var t=getEl(this.domElement,"currentPageInput"),e=t.value,a=1,i=Math.ceil(this.total/this.getPageSize());(isEmpty(e)||isNaN(parseInt(e)))&&(e=a),page=parseInt(e),page<a?page=a:page>i&&(page=i),this.offset=page*this.getPageSize()-this.getPageSize(),this.updateDisplayValues(),this.dispatchChangePageEvent()},Paginator.prototype.onKeypressPageSizeInput=function(t){13==t.keyCode&&this.refresh()},Paginator.prototype.onKeypressCurrentPageInput=function(t){13==t.keyCode&&this.onClickGoToPageButton()},Paginator.prototype.updateDisplayValues=function(){var t=getEl(this.domElement,"currentPageInput"),e=getEl(this.domElement,"total"),a=getEl(this.domElement,"fromRecord"),i=getEl(this.domElement,"toRecord");this.currentPage=Math.ceil((this.offset+1)/this.getPageSize()),t.value=this.currentPage,e.innerHTML=this.total,a.innerHTML=this.offset+1,i.innerHTML=this.offset+(isEmpty(this.data)?0:this.data.length)},Paginator.prototype.getPageSize=function(){var t=getEl(this.domElement,"pageSizeInput"),e=t.value;return(isEmpty(e)||isNaN(parseInt(e)))&&(e=this.maxPageSize),pageSize=parseInt(e),pageSize<1?pageSize=1:!isEmpty(this.total)&&pageSize>this.total&&(pageSize=this.total),t.value=pageSize,this.pageSize=pageSize,pageSize},Paginator.prototype.dispatchChangePageEvent=function(){var t=new CustomEvent(CHANGE_PAGE,{detail:{offset:this.offset,pageSize:this.getPageSize()},bubbles:!0});this.domElement.dispatchEvent(t)};
function ViewFrame(e){Widget.apply(this,arguments),this.owner=e,this.name=""}extend(ViewFrame,Widget);
function Widget(){this.domElement=null}Widget.prototype.getDomElement=function(){return this.domElement},Widget.prototype.render=function(){},Widget.prototype.init=function(){},Widget.prototype.setData=function(t){},Widget.prototype.setVisible=function(t){var e=t?"block":"none";this.domElement.style.display=e};
var Settings=function(){function t(){return this instanceof t?void(this.config={}):new t}var n;return t.prototype={getDutyListPageSize:function(){return this.config.ui.dutyListPageSize},getDutyListColumns:function(){var t=this.config.meta.dutyGridColumns,n=[];for(var i in t)n.push({column:i,name:t[i]});return n}},{init:function(){return n?n:n=t.apply(null,arguments)},getInstance:function(){return n?n:this.init.apply(this,arguments)}}}();
var JOURNAL="journal",INDEX="index",DUTY_LIST_FRAME="dutyList",DUTY="duty",STATISTICS="statistics",DICTIONARY="dictionary",NAVIGATION={index:[{label:"Боевые дежурства",icon:"img/",notificationType:CALL_INDEX_MODULE},{label:"Статистика",icon:"img/",notificationType:CALL_STATISTICS_MODULE},{label:"Управление данными",icon:"img/",notificationType:CALL_DICTIONARY_MODULE}],dictionary:[{label:"Провизия",icon:"img/",notificationType:CALL_PROVISION_DATA},{label:"Технические ресурсы",icon:"img/",notificationType:CALL_TECHNICAL_DATA}],duty:[{label:"Основные параметры",icon:"img/",notificationType:CALL_MAIN_DUTY_DATA},{label:"Погода",icon:"img/",notificationType:CALL_WEATHER_DUTY_DATA}]};
var CHANGE_PAGE="changePage",CHANGE_PAGE_SIZE="changePageSize",SORT_GRID="sortGrid",REMOVE_DUTY="removeDuty",EDITT_DUTY="editDuty";
var VIEW_READY="viewReady",LOAD_JOURNAL_STATUS="loadJournalStatus",CALL_START_DUTY="callStartDuty",CALL_COMPLETE_RUN_UP="callCompleteRunUp",CALL_COMPLETE_DUTY="callCompleteDuty",CALL_INDEX_MODULE="callIndexModule",CALL_DUTY_MODULE="callDutyModule",CALL_STATISTICS_MODULE="callStatisticsModule",CALL_DICTIONARY_MODULE="callDictionaryModule",CALL_LOAD_DUTY_LIST="callLoadDutyList",CHANGE_LAST_DUTY_INFO="changeLastDutyInfo",CHANGE_ACTIVE_DUTY_INFO="changeActiveDutyInfo",LOAD_CONFIG_COMPLETE="loadConfigComplete",LOAD_JOURNAL_GRID_DATA="loadJournalGridData",CREATE_DUTY_COMPLETE="createDutyComplete",RUN_UP_COMPLETE="runUpComplete",DUTY_COMPLETE="dutyComplete",LOAD_DUTY_LIST="loadDutyList",CHANGE_SYSTEM_MENU="changeSystemMenu",CHANGE_MODULE_MENU="changeModuleMenu",CHANGE_MODULE="changeModule",CHANGE_JOURNAL_GRID_COLUMNS="changeJournalGridColumns",CHANGE_JOURNAL_GRID_ROWS="changeJournalGridRows",CHANGE_DUTY_LIST="changeDutyList",CALL_PROVISION_DATA="callProvisionData",CALL_TECHNICAL_DATA="callTechnicalData",CALL_MAIN_DUTY_DATA="callMainDutyData",CALL_WEATHER_DUTY_DATA="callWeatherDutyData";
var INITIAL_STATE="initialState";
function Service(){Dispatcher.apply(this,arguments)}extend(Service,Dispatcher),Service.prototype.loadConfig=function(e){this.sendRequest("GET",LOAD_CONFIG_COMPLETE,{request:"loadFile",url:e,message:"Загрузка файла конфигурации"})},Service.prototype.getJournalStatus=function(){this.sendRequest("GET",LOAD_JOURNAL_STATUS,{request:"getJournalStatus",message:"Определение статуса журнала"})},Service.prototype.createDuty=function(){this.sendRequest("POST",CREATE_DUTY_COMPLETE,{request:"createDuty",message:"Создание боевого дежурства"})},Service.prototype.completeRunUp=function(){this.sendRequest("POST",RUN_UP_COMPLETE,{request:"completeRunUp",message:"Завершение подготовки к дежурству"})},Service.prototype.completeDuty=function(){this.sendRequest("POST",DUTY_COMPLETE,{request:"completeDuty",message:"Завершение боевого дежурства"})},Service.prototype.getDutyList=function(e){var t=null,s=e.sort;isEmpty(s)||(t=JSON.stringify(s)),this.sendRequest("GET",LOAD_DUTY_LIST,{request:"getDutyList",offset:e.offset,pageSize:e.pageSize,sort:t,message:"Загрузка списка боевых дежурств"})},Service.prototype.sendRequest=function(e,t,s){isEmpty(i)&&(i=Settings.getInstance().config.serviceUrl);var i,n,r=null;isEmpty(s.message)?n="Загрузка данных":(n=s.message,delete s.message),s.time=(new Date).getTime(),"loadFile"==s.request?i=s.url:(i=Settings.getInstance().config.serviceUrl,"GET"==e?i+="?"+createUrl(s):"POST"==e&&(r=JSON.stringify(s)));var o=this,a=new XMLHttpRequest;a.parameters=s,a.notification=t,a.onreadystatechange=function(){if(4==this.readyState&&200==this.status){Notifier.getInstance().hideProgress(this.progressEl);var e=JSON.parse(this.responseText);isEmpty(e.result)?"loadFile"==s.request?o.sendNotification(new Notification(this.notification,e)):Notifier.getInstance().showError("Произошла ошибка, приносим свои извинения.",e.error):o.sendNotification(new Notification(this.notification,e.result))}},a.open(e,i,!0),"POST"==e&&a.setRequestHeader("Content-type","application/json; charset=utf-8"),a.progressEl=Notifier.getInstance().showProgress(n),a.send(r)};
function getElement(e,n){for(var t=0;t<e.length;t++)if(e[t]===n)return e[t]}function getElementByFieldValue(e,n,t){for(var r=0;r<t.length;r++)if(t[r][e]===n)return t[r]}
function extend(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t}function isEmpty(t,e){return null==t||(e?!1:""===t)||Array.isArray(t)&&0===t.length}function capitalize(t){return t.charAt(0).toUpperCase()+t.slice(1)}function createUrl(t){return Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}function getEl(t,e,r,o){var n=isEmpty(r)?"["+e+"]":"["+e+"="+r+"]";isEmpty(t)&&(t=document);var i=t.querySelectorAll(n),u=null;return isEmpty(i)||(u=o?i:i[0]),u}function removeChilds(t){for(var e;e=t.lastChild;)t.removeChild(e)}function removeEl(t,e,r,o){var n=getEl(t,e,r,o);if(!isEmpty(n)){n=n instanceof NodeList?n:[n];for(var i,u=n.length,a=0;u>a;a++)i=n[a],i.parentNode.removeChild(i)}}function clone(t){return JSON.parse(JSON.stringify(t))}function getDateString(t){if(isEmpty(t))return"-";"number"==typeof t&&(t=new Date(1e3*t));var e=formatDoubleDigit(t.getDate()),r=formatDoubleDigit(t.getMonth()+1),o=t.getFullYear(),n=formatDoubleDigit(t.getHours()),i=formatDoubleDigit(t.getMinutes());return e+"."+r+"."+o+" "+n+":"+i}function getDurationString(t){if(isEmpty(t))return"-";var e=t,r=formatDoubleDigit(Math.floor(e/3600));e%=3600;var o=formatDoubleDigit(Math.floor(e/60)),n=formatDoubleDigit(e%60);return r+":"+o+":"+n}function formatDoubleDigit(t){return 10>t?"0"+t:t}function getBounds(t){var e=document.defaultView.getComputedStyle(t,null);return{x:"auto"==e.left?0:parseInt(e.left),y:"auto"==e.top?0:parseInt(e.top),width:parseInt(e.width),height:parseInt(e.height)}}
Array.isArray||(Array.isArray=function(r){return"[object Array]"===Object.prototype.toString.call(r)});
function ActionColumn(t,n,e){this.actionColumn=!0,this.grid=t,this.column=n||"remove",this.name=e||""}ActionColumn.prototype.createHeaderElement=function(){var t={};t[this.grid.COLUMN_NAME]=this.column,t[this.grid.COLUMN_FIELD]=this.name;var n=this.grid.createColumn(t);return n},ActionColumn.prototype.createCellElement=function(){},ActionColumn.prototype.dispatchActionEvent=function(t,n){var e=new CustomEvent(t,{detail:n,bubbles:!0});this.grid.getDomElement().dispatchEvent(e)};
function ActionColumnsConfig(i,t){this.left=i,this.right=t}
function CustomRow(t){Widget.apply(this,arguments),this.grid=t}extend(CustomRow,Widget),CustomRow.prototype.isCustomRow=function(t){return!1},CustomRow.prototype.createRowEl=function(t,o){return null};
function DataGrid(t,e,s){Widget.apply(this,arguments),this.TABLE_ATTR="table",this.COLUMNS_ATTR="columns",this.COLUMN_ATTR="column",this.ROW_ATTR="row",this.CELL_ATTR="cell",this.EMPTY_ROW="emptyRow",this.EMPTY_CELL="emptyCell",this.EMPTY_ROW_TEXT=t||"Список пуст",this.COLUMN_NAME=e||"column",this.COLUMN_FIELD=s||"name",this.columnsData=[],this.rowsData=[],this.actionColumns=[],this.customRows=[],this.sort=null}extend(DataGrid,Widget),DataGrid.prototype.render=function(){this.domElement=document.createElement("div"),this.domElement.className="dataGrid";var t=document.createElement("table");return t.setAttribute(this.TABLE_ATTR,""),this.domElement.appendChild(t),this.domElement},DataGrid.prototype.getTableEl=function(){return getEl(this.domElement,this.TABLE_ATTR)},DataGrid.prototype.setCustom=function(t,e){this.actionColumns=t,this.customRows=e},DataGrid.prototype.setColumns=function(t){this.configureColumnsData(t);var e=this.getTableEl();removeEl(e,this.COLUMN_ATTR,null,!0);var s=this.createColumns();e.appendChild(s),this.showEmptyRow()},DataGrid.prototype.configureColumnsData=function(t){var e=function(t){return!isEmpty(this.actionColumns)&&this.actionColumns[t]||[]};this.columnsData=this.columnsData.concat(e.call(this,"left"),t,e.call(this,"right"))},DataGrid.prototype.createColumns=function(){var t=document.createElement("tr");t.setAttribute(this.COLUMNS_ATTR,""),t.className="gridHead";for(var e=0;e<this.columnsData.length;e++){var s=this.columnsData[e],i=this.createColumn(s);t.appendChild(i)}return t},DataGrid.prototype.createColumn=function(t){var e=t[this.COLUMN_NAME],s=document.createElement("td");s.setAttribute(this.COLUMN_ATTR,e);var i="";t.actionColumn||(i='<div class="columnSort"><div sort="ASC" class="sortAscOff"></div><div sort="DESC" class="sortDescOff"></div></div>');var o=t[this.COLUMN_FIELD],a='<div class="columnContainer"><div title class="columnTitle">'+o+"</div>"+i+'<div class="clearBoth"></div></div>';return s.innerHTML=a,t.actionColumn||this.configureSortButtons(s,e),s},DataGrid.prototype.configureSortButtons=function(t,e){var s=function(s){var i=getEl(t,"sort",s);i.columnKey=e,i.addEventListener("click",this.onSortButton.bind(this))};s.call(this,"ASC"),s.call(this,"DESC")},DataGrid.prototype.onSortButton=function(t){var e=t.target,s=e.getAttribute("sort"),i=e.columnKey,o=null;(isEmpty(this.sort)||this.sort[i]!=s)&&(o={},o[i]=s);var a=new CustomEvent(SORT_GRID,{detail:o,bubbles:!0});this.domElement.dispatchEvent(a)},DataGrid.prototype.updateColumnsSort=function(){if(!isEmpty(this.sort))for(var t,e,s,i,o,a,r=0;r<this.columnsData.length;r++)if(t=this.columnsData[r],!t.actionColumn)switch(e=t[this.COLUMN_NAME],s=getEl(this.domElement,this.COLUMN_ATTR,e),o=getEl(s,"sort","ASC"),a=getEl(s,"sort","DESC"),i=this.sort[e]){case"ASC":o.className="sortAscOn",a.className="sortDescOff";break;case"DESC":o.className="sortAscOff",a.className="sortDescOn";break;default:o.className="sortAscOff",a.className="sortDescOff"}},DataGrid.prototype.getColumnsCount=function(){var t=0;if(isEmpty(this.columnsData)||(t+=this.columnsData.length),!isEmpty(this.actionColumns)){var e=function(t){var e=this.actionColumns[t];return isEmpty(e)?0:e.length};t+=e("left").bind(this)+e("right").bind(this)}return t},DataGrid.prototype.setData=function(t,e){var s=this.getTableEl();if(!isEmpty(t)){this.rowsData=t,this.sort=e,this.updateColumnsSort(),removeEl(s,this.ROW_ATTR,null,!0);for(var i=this.createRows(),o=0;o<i.length;o++){var a=i[o];s.appendChild(a)}}},DataGrid.prototype.createRows=function(){for(var t,e,s=[],i=0;i<this.rowsData.length;i++)t=this.rowsData[i],e=this.createRow(t,i),s.push(e);return s},DataGrid.prototype.createRow=function(t,e){var s=null,i=this.isCustomRow(t);return s=isEmpty(i)?this.createSimpleRow(t,e):i.createRowEl(t,e)},DataGrid.prototype.isCustomRow=function(t){if(!isEmpty(this.customRows))for(var e=0;e<this.customRows.length;e++){var s=this.customRows[e];if(s.isCustomRow(t))return s}return null},DataGrid.prototype.createSimpleRow=function(t,e){var s=document.createElement("tr");return s.setAttribute(this.ROW_ATTR,this.getRowAttributeValue(e)),s.baseCls="gridRow",s.defaultBgCls=e%2==0?"altColor1":"altColor2",s.overBgCls="overColor",s.className=s.baseCls+" "+s.defaultBgCls,s.addEventListener("mouseover",function(t){this.className=this.baseCls+" "+this.overBgCls}),s.addEventListener("mouseout",function(t){this.className=this.baseCls+" "+this.defaultBgCls}),this.createRowCells(t,s),s},DataGrid.prototype.getRowAttributeValue=function(t){return this.ROW_ATTR+"-"+(t+1)},DataGrid.prototype.showEmptyRow=function(){var t=this.getTableEl(),e=document.createElement("tr");e.setAttribute(this.ROW_ATTR,this.EMPTY_ROW),e.className="gridRow";var s=document.createElement("td");s.setAttribute(this.CELL_ATTR,this.EMPTY_CELL),s.className="emptyCell";var i=document.createTextNode(this.EMPTY_ROW_TEXT);s.appendChild(i),s.setAttribute("colspan",this.columnsData.length),e.appendChild(s),t.appendChild(e)},DataGrid.prototype.createRowCells=function(t,e){for(var s=0;s<this.columnsData.length;s++){var i,o=this.columnsData[s];if(o.actionColumn)i=o.createCellElement();else{var a=o[this.COLUMN_NAME],r=t[a];i=this.createCell(r,a)}e.appendChild(i)}},DataGrid.prototype.createCell=function(t,e){var s=document.createElement("td");return s.setAttribute(this.CELL_ATTR,e),s.innerHTML=t,s};
function EditColumn(){ActionColumn.apply(this,arguments)}extend(EditColumn,ActionColumn),EditColumn.prototype.createCellElement=function(){var t=document.createElement("td");return t.setAttribute(this.grid.CELL_ATTR,"edit-cell"),t.innerHTML='<div class="editCell"></div>',t.addEventListener("click",function(){this.dispatchActionEvent(EDITT_DUTY,{dutyId:null})}.bind(this)),t};
function RemoveColumn(){ActionColumn.apply(this,arguments)}extend(RemoveColumn,ActionColumn),RemoveColumn.prototype.createCellElement=function(){var e=document.createElement("td");return e.setAttribute(this.grid.CELL_ATTR,"remove-cell"),e.innerHTML='<div class="removeCell"></div>',e.addEventListener("click",function(){this.dispatchActionEvent(REMOVE_DUTY,{dutyId:null})}.bind(this)),e};
var Bus=function(){function t(){return this instanceof t?void(this.dispatcher=new Dispatcher):new t}var n;return t.prototype={addReceiver:function(t){this.dispatcher.addReceiver(t)},sendNotification:function(t){this.dispatcher.sendNotification(t)}},{init:function(){return n?n:n=t.apply(null,arguments)},getInstance:function(){return n?n:this.init.apply(this,arguments)}}}();
function Module(e,t,i,o){this.name=e,this.model=new t,this.view=new i,this.service=new Service,this.controller=new o(this.model,this.view,this.service),this.mapComponents()}Module.prototype.mapComponents=function(){this.model.addReceiver(this.view),this.model.addReceiver(this.controller),this.view.addReceiver(this.controller),this.service.addReceiver(this.controller),Bus.getInstance().addReceiver(this.controller)},Module.prototype.getDomElement=function(){return isEmpty(this.view.domElement)&&this.view.render(),this.view.domElement},Module.prototype.getMenu=function(){return NAVIGATION[this.name]};
var ModuleManager=function(){function e(){return this instanceof e?void(this.moduleMap={}):new e}var n;return e.prototype={getModule:function(e){var n=null;return isEmpty(this.moduleMap[e])?(n=this.create(e),isEmpty(n)||(this.moduleMap[e]=n)):n=this.moduleMap[e],n},create:function(e){var n=null;switch(e){case JOURNAL:n=new Module(e,JournalModel,JournalView,JournalController);break;case INDEX:n=new Module(e,IndexModel,IndexView,IndexController);break;case DUTY:n=new Module(e,DutyModel,DutyView,DutyController);break;case DICTIONARY:n=new Module(e,DictionaryModel,DictionaryView,DictionaryController);break;case STATISTICS:default:Notifier.getInstance().showError("Ошибка при создании модуля",'Модуль с наименованием "'+e+'" в системе не зарегистрирован')}return n}},{init:function(){return n?n:n=e.apply(null,arguments)},getInstance:function(){return n?n:this.init.apply(this,arguments)}}}();
function ModuleView(){View.apply(this,arguments),this.moduleTitle="Раздел",this.framesMap={},this.frameTitleEl=null,this.frameContainerEl=null}extend(ModuleView,View),ModuleView.prototype.render=function(){var e='<div class="moduleHeader"><span moduleTitle>'+this.moduleTitle+"</span> / <span frameTitle></span></div><div frameContainer></div>";this.domElement=document.createElement("div"),this.domElement.setAttribute("module",this.moduleTitle),this.domElement.innerHTML=e,this.frameTitleEl=getEl(this.domElement,"frameTitle"),this.frameContainerEl=getEl(this.domElement,"frameContainer")},ModuleView.prototype.showFrame=function(e){removeChilds(this.frameContainerEl);var t=this.getFrame(e),i=t.getDomElement();return isEmpty(i)&&(i=t.render()),this.frameContainerEl.appendChild(i),this.frameTitleEl.innerHTML=t.name,t.init(),t},ModuleView.prototype.getFrame=function(e){var t=null;return isEmpty(this.framesMap[e])?(t=this.createFrame(e),this.framesMap[e]=t):t=this.framesMap[e],t},ModuleView.prototype.createFrame=function(e){return this["create"+capitalize(e)+"Frame"]()};
function DutyController(t,o,r){Controller.apply(this,arguments)}extend(DutyController,Controller),DutyController.prototype.getHandlers=function(){return Controller.prototype.getHandlers.apply(this,arguments).concat([])},DutyController.prototype.init=function(){};
function DutyModel(){Model.apply(this,arguments),this.columns=[],this.rows=[]}extend(DutyModel,Model),DutyModel.prototype.setColumns=function(t){this.columns=t,this.sendNotification(new Notification(CHANGE_JOURNAL_GRID_COLUMNS,this.columns))},DutyModel.prototype.setRows=function(t){this.rows=t,this.sendNotification(new Notification(CHANGE_JOURNAL_GRID_ROWS,this.rows))};
function DutyView(){View.apply(this,arguments),this.dutyGrid=null,this.paginator=null}extend(DutyView,View),DutyView.prototype.getHandlers=function(){return[]},DutyView.prototype.render=function(){return this.domElement=document.createElement("div"),this.createTools(),this.createPaginator(),this.sendNotification(new Notification(VIEW_READY)),this.domElement},DutyView.prototype.createTools=function(){var t='<div style="font-weight: bold;">Боевые дежурства:</div>';this.domElement.insertAdjacentHTML("afterbegin",t)},DutyView.prototype.createGrid=function(){this.dutyGrid=new DataGrid;var t=this.dutyGrid.domElement;this.domElement.appendChild(t)},DutyView.prototype.createPaginator=function(){this.paginator=new Paginator,this.domElement.appendChild(this.paginator.getDomElement())};
function IndexController(t,o,e){Controller.apply(this,arguments)}extend(IndexController,Controller),IndexController.prototype.getHandlers=function(){return Controller.prototype.getHandlers.apply(this,arguments).concat([{type:LOAD_DUTY_LIST,handler:this.onLoadDutyList},{type:CALL_LOAD_DUTY_LIST,handler:this.onCallLoadDutyList}])},IndexController.prototype.onLoadDutyList=function(t){this.model.setDutyList(t)},IndexController.prototype.onCallLoadDutyList=function(t){this.service.getDutyList(t)};
function IndexModel(){Model.apply(this,arguments),this.dutyList=null}extend(IndexModel,Model),IndexModel.prototype.setDutyList=function(t){this.dutyList=t,this.sendNotification(new Notification(CHANGE_DUTY_LIST,this.dutyList))};
function IndexView(){ModuleView.apply(this,arguments),this.moduleTitle="Главная"}extend(IndexView,ModuleView),IndexView.prototype.render=function(){ModuleView.prototype.render.apply(this,arguments),this.showFrame(DUTY_LIST_FRAME)},IndexView.prototype.getHandlers=function(){return[{type:CHANGE_DUTY_LIST,handler:this.onChangeDutyList}]},IndexView.prototype.createDutyListFrame=function(){var e=new DutyListFrame(this);return e},IndexView.prototype.refreshDutyList=function(){var e=this.getFrame(DUTY_LIST_FRAME);e.refreshDutyList()},IndexView.prototype.onChangeDutyList=function(e){var t=this.getFrame(DUTY_LIST_FRAME);t.setDutyList(e)};
function DictionaryController(o,r,n){Controller.apply(this,arguments)}extend(DictionaryController,Controller);
function DictionaryModel(){Model.apply(this,arguments)}extend(DictionaryModel,Model);
function DictionaryView(){ModuleView.apply(this,arguments),this.moduleTitle="Управление данными"}extend(DictionaryView,ModuleView);
function JournalController(t,o,e){Controller.apply(this,arguments)}extend(JournalController,Controller),JournalController.prototype.getHandlers=function(){return Controller.prototype.getHandlers.apply(this,arguments).concat([{type:LOAD_CONFIG_COMPLETE,handler:this.onLoadConfig},{type:LOAD_JOURNAL_STATUS,handler:this.onLoadJournalStatus},{type:CREATE_DUTY_COMPLETE,handler:this.onCreateDutyComplete},{type:RUN_UP_COMPLETE,handler:this.onRunUpComplete},{type:DUTY_COMPLETE,handler:this.onDutyComplete},{type:DUTY_COMPLETE,handler:this.onDutyComplete},{type:CALL_START_DUTY,handler:this.onCallStartDuty},{type:CALL_COMPLETE_RUN_UP,handler:this.onCallCompleteRunUp},{type:CALL_COMPLETE_DUTY,handler:this.onCallCompleteDuty},{type:CALL_INDEX_MODULE,handler:this.onCallIndexModule},{type:CALL_DUTY_MODULE,handler:this.onCallDutyModule},{type:CALL_STATISTICS_MODULE,handler:this.onCallStatisticsModule},{type:CALL_DICTIONARY_MODULE,handler:this.onCallDictionaryModule}])},JournalController.prototype.init=function(){this.service.loadConfig("config.json")},JournalController.prototype.onLoadConfig=function(t){Settings.getInstance().config=t,this.service.getJournalStatus()},JournalController.prototype.onLoadJournalStatus=function(t){this.model.setJournalStatus(t),this.model.updateSystemMenu(),this.onCallIndexModule()},JournalController.prototype.onCreateDutyComplete=function(t){this.model.setActiveDuty(t),this.model.updateSystemMenu()},JournalController.prototype.onRunUpComplete=function(t){this.model.setActiveDuty(t),this.model.updateSystemMenu()},JournalController.prototype.onDutyComplete=function(t){this.onLoadJournalStatus(t)},JournalController.prototype.onCallStartDuty=function(){this.service.createDuty()},JournalController.prototype.onCallCompleteRunUp=function(){Dialog.getInstance().show(Settings.getInstance().config.dialogs.completeRunUp,{context:this,"Да":function(){this.service.completeRunUp()},"Нет":null})},JournalController.prototype.onCallCompleteDuty=function(){Dialog.getInstance().show(Settings.getInstance().config.dialogs.completeDuty,{context:this,"Да":function(){this.service.completeDuty()},"Нет":null})},JournalController.prototype.onCallIndexModule=function(){var t=ModuleManager.getInstance().getModule(INDEX);this.model.setModule(t)},JournalController.prototype.onCallDictionaryModule=function(){var t=ModuleManager.getInstance().getModule(DICTIONARY);this.model.setModule(t)},JournalController.prototype.onCallDutyModule=function(){},JournalController.prototype.onCallShowStatistics=function(){};
function JournalModel(){Model.apply(this,arguments),this.startDutyMenuItem={label:"Начать дежурство",icon:"img/",notificationType:CALL_START_DUTY},this.completeRunUpMenuItem={label:"Завершить подготовку",icon:"img/",notificationType:CALL_COMPLETE_RUN_UP},this.completeDutyMenuItem={label:"Завершить дежурство",icon:"img/",notificationType:CALL_COMPLETE_DUTY},this.goToIndexMenuItem={label:"На главную",icon:"img/",notificationType:CALL_INDEX_MODULE},this.lastDutyInfo=null,this.activeDutyInfo=null,this.currentModule=null}extend(JournalModel,Model),JournalModel.prototype.setJournalStatus=function(t){this.setLastDuty(t.lastDuty),this.setActiveDuty(t.activeDuty)},JournalModel.prototype.setLastDuty=function(t){this.lastDutyInfo=t,this.sendNotification(new Notification(CHANGE_LAST_DUTY_INFO,this.lastDutyInfo))},JournalModel.prototype.setActiveDuty=function(t){if(isEmpty(t))this.activeDutyInfo=null;else{var e=t.runUpTime,i=t.duration;this.activeDutyInfo={date:t.date,duration:i,runUpTime:e,runUp:!1},0==e&&(this.activeDutyInfo.runUp=!0,this.activeDutyInfo.runUpTime=i)}this.sendNotification(new Notification(CHANGE_ACTIVE_DUTY_INFO,this.activeDutyInfo))},JournalModel.prototype.updateSystemMenu=function(){var t=[];isEmpty(this.activeDutyInfo)?t.unshift(this.startDutyMenuItem):this.activeDutyInfo.runUp?t.unshift(this.completeRunUpMenuItem,this.completeDutyMenuItem):t.unshift(this.completeDutyMenuItem),isEmpty(this.currentModule)||this.currentModule.name==INDEX||t.push(this.goToIndexMenuItem),this.sendNotification(new Notification(CHANGE_SYSTEM_MENU,t))},JournalModel.prototype.setModule=function(t){this.currentModule=t;var e=this.currentModule.getMenu(),i=this.currentModule.getDomElement();this.sendNotification(new Notification(CHANGE_MODULE,{menu:e,domElement:i})),this.updateSystemMenu()};
function JournalView(e){View.apply(this,arguments),this.durationTimer=null,this.moduleContainerEl=null}extend(JournalView,View),JournalView.prototype.getHandlers=function(){return[{type:CHANGE_LAST_DUTY_INFO,handler:this.onChangeLastDutyInfo},{type:CHANGE_ACTIVE_DUTY_INFO,handler:this.onChangeActiveDutyInfo},{type:CHANGE_SYSTEM_MENU,handler:this.onChangeSystemMenu},{type:CHANGE_MODULE,handler:this.onChangeModule}]},JournalView.prototype.render=function(){this.domElement=document.getElementById("content");var e='<div id="layoutBody"><header id="header"><div class="lastDutyInfo" last-duty-info><span>Последнее дежурство:&nbsp;</span><span last-duty-date>-</span><span>&nbsp;Длительность:&nbsp;</span><span last-duty-duration>-</span></div><div class="activeDutyInfo" active-duty-info style="display: none;"><span>Начало дежурства:&nbsp;</span><span active-duty-start-date>-</span><span>&nbsp;Время подготовки:&nbsp;</span><span run-up-time>-</span><span>&nbsp;Время дежурства:&nbsp;</span><span duty-duration>-</span></div><div class="clearBoth"></div></header><nav id="navigationPanel"><div id="navigation" menu><div system-menu></div><div module-menu></div></div></nav><section id="frameContainer" moduleContainer></section><footer id="footer"></footer></div>';this.domElement.innerHTML=e,this.moduleContainerEl=getEl(this.domElement,"moduleContainer"),new JournalLayout,this.sendNotification(new Notification(VIEW_READY))},JournalView.prototype.onChangeLastDutyInfo=function(e){if(!isEmpty(e)){var n=getEl(this.domElement,"last-duty-date"),t=getEl(this.domElement,"last-duty-duration");n.innerHTML=getDateString(e.date),t.innerHTML=getDurationString(e.duration)}},JournalView.prototype.onChangeActiveDutyInfo=function(e){var n=getEl(this.domElement,"active-duty-info");if(clearInterval(this.durationTimer),isEmpty(e))n.style.display="none";else{var t=getEl(this.domElement,"active-duty-start-date");t.innerHTML=getDateString(e.date);var i=e.duration,a=getEl(this.domElement,"duty-duration");a.innerHTML=getDurationString(i);var o=getEl(this.domElement,"run-up-time");o.innerHTML=getDurationString(e.runUpTime),this.durationTimer=setInterval(function(){i++,a.innerHTML=getDurationString(i),e.runUp&&(o.innerHTML=getDurationString(i))},1e3),n.style.display="block"}},JournalView.prototype.onChangeSystemMenu=function(e){var n=getEl(this.domElement,"system-menu");this.createMenu(e,n)},JournalView.prototype.onChangeModule=function(e){this.changeModuleMenu(e.menu),this.showModule(e.domElement)},JournalView.prototype.changeModuleMenu=function(e){var n=getEl(this.domElement,"module-menu");this.createMenu(e,n)},JournalView.prototype.createMenu=function(e,n){removeChilds(n);var t,i,a,o=e.length,r=this;for(a=0;o>a;a++)t=e[a],i=this.createMenuItemElement(t),i.menuItem=t,i.addEventListener("click",function(){r.sendNotification(new Notification(this.menuItem.notificationType,this.menuItem))}),n.appendChild(i)},JournalView.prototype.createMenuItemElement=function(e){var n='<a href="#'+e.notificationType+'">'+e.label+"</a>",t=document.createElement("div");return t.className="menuItem",t.innerHTML=n,t},JournalView.prototype.showModule=function(e){removeChilds(this.moduleContainerEl),this.moduleContainerEl.appendChild(e)};
function ActiveDutyRow(){CustomRow.apply(this,arguments)}extend(ActiveDutyRow,CustomRow),ActiveDutyRow.prototype.isCustomRow=function(t){return!isEmpty(t.activeDuty)},ActiveDutyRow.prototype.createRowEl=function(t,e){var i=document.createElement("tr");return i.setAttribute(this.grid.ROW_ATTR,this.grid.getRowAttributeValue(e)),i.className="gridRow activeDutyGridRow",this.grid.createRowCells(t,i),this.runTimers(t,i),i},ActiveDutyRow.prototype.runTimers=function(t,e){var i=this.getCountingCells(t,e);if(!isEmpty(i)){var o=t.activeDuty.duration;this.updateCountingCells(i,o)}},ActiveDutyRow.prototype.getCountingCells=function(t,e){for(var i=[],o=t.activeDuty.columns,u=0;u<o.length;u++){var n=o[u],r=getEl(e,this.grid.CELL_ATTR,n);isEmpty(r)||i.push(r)}return i},ActiveDutyRow.prototype.updateCountingCells=function(t,e){for(var i=t.length,o=0;i>o;o++)t[o].innerHTML='<span style="font-style: italic;">определяется</span>'};
function DutyListFrame(){ViewFrame.apply(this,arguments),this.name="Список боевых дежурств",this.paginator=null,this.grid=null}extend(DutyListFrame,ViewFrame),DutyListFrame.prototype.render=function(){return this.domElement=document.createElement("div"),this.domElement.className="dutyListFrame",this.createGrid(),this.createPaginator(),this.domElement},DutyListFrame.prototype.init=function(){this.paginator.refresh()},DutyListFrame.prototype.setDutyList=function(t){this.paginator.setData(t.data,t.count),this.grid.setData(t.data,t.sort),this.paginator.setVisible(!isEmpty(t.data))},DutyListFrame.prototype.refreshDutyList=function(){this.paginator.refresh()},DutyListFrame.prototype.createGrid=function(){var t=Settings.getInstance().getDutyListColumns();this.grid=new DataGrid("Список боевых дежурств пуст"),this.grid.render();var i=this.grid.getDomElement(),e=new ActionColumnsConfig(null,[new EditColumn(this.grid),new RemoveColumn(this.grid)]),n=[new ActiveDutyRow(this.grid)];this.grid.setCustom(e,n),this.grid.setColumns(t),this.domElement.appendChild(i),i.addEventListener(EDITT_DUTY,function(t){t.stopPropagation(),alert("Редактирование боевого дежурства: "+t.detail.dutyId)}),i.addEventListener(REMOVE_DUTY,function(t){t.stopPropagation(),alert("Удаление боевого дежурства: "+t.detail.dutyId)}),i.addEventListener(SORT_GRID,function(t){t.stopPropagation(),this.owner.sendNotification(new Notification(CALL_LOAD_DUTY_LIST,{offset:this.paginator.offset,pageSize:this.paginator.pageSize,sort:t.detail}))}.bind(this))},DutyListFrame.prototype.createPaginator=function(){this.paginator=new Paginator(Settings.getInstance().getDutyListPageSize()),this.paginator.render();var t=this.paginator.getDomElement();this.paginator.setVisible(!1),this.domElement.appendChild(t),t.addEventListener(CHANGE_PAGE,function(t){t.stopPropagation(),this.owner.sendNotification(new Notification(CALL_LOAD_DUTY_LIST,{offset:t.detail.offset,pageSize:t.detail.pageSize,sort:this.grid.sort}))}.bind(this))};